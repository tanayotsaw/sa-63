'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

function _interopDefault (ex) { return (ex && (typeof ex === 'object') && 'default' in ex) ? ex['default'] : ex; }

var Router = _interopDefault(require('express-promise-router'));
var createProxyMiddleware = _interopDefault(require('http-proxy-middleware'));

function buildMiddleware(pathPrefix, logger, route, config2) {
  const fullConfig = typeof config2 === "string" ? {target: config2} : {...config2};
  if (fullConfig.pathRewrite === void 0) {
    const routeWithSlash = route.endsWith("/") ? route : `${route}/`;
    fullConfig.pathRewrite = {
      [`^${pathPrefix}${routeWithSlash}`]: "/"
    };
  }
  if (fullConfig.changeOrigin === void 0) {
    fullConfig.changeOrigin = true;
  }
  fullConfig.logProvider = () => logger;
  return createProxyMiddleware(fullConfig);
}
async function createRouter(options) {
  var _a;
  const router = Router();
  const proxyConfig = (_a = options.config.getOptional("proxy")) != null ? _a : {};
  Object.entries(proxyConfig).forEach(([route, proxyRouteConfig]) => {
    router.use(route, buildMiddleware(options.pathPrefix, options.logger, route, proxyRouteConfig));
  });
  return router;
}

exports.createRouter = createRouter;
